local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "LARB HACK | Blox Fruits Ultimate",
   LoadingTitle = "AA-7.0 Optimization",
   LoadingSubtitle = "By LARB SYSTEM",
   ConfigurationSaving = {
      Enabled = true,
      FolderName = "LarbHackConfig",
      FileName = "BloxFruits"
   },
   KeySystem = false,
})

local MainTab = Window:CreateTab("Auto Farm", 4483362458)
local StatsTab = Window:CreateTab("Auto Stats", 4483362458)
local MiscTab = Window:CreateTab("Misc", 4483362458)

-- Variables
_G.AutoFarm = false
_G.AutoQuest = true -- Default to true if AutoFarm is on
_G.AutoChest = false
_G.AutoStats = false
_G.SelectStat = "Melee" 

-- Data Tables
local QuestList = {
    -- Format: {LevelReq, QuestName, QuestGiverName, MobName, MobLevel}
    {0, "BanditQuest1", "Bandit Quest Giver", "Bandit", 5},
    {10, "JungleQuest", "Monkey Quest Giver", "Monkey", 14},
    {15, "JungleQuest", "Monkey Quest Giver", "Gorilla", 20},
    {30, "BuggyQuest1", "Pirate Adventurer", "Pirate", 35}, 
    {40, "BuggyQuest1", "Pirate Adventurer", "Brute", 45},
    {60, "DesertQuest", "Desert Adventurer", "Desert Bandit", 60},
    {75, "DesertQuest", "Desert Adventurer", "Desert Officer", 70},
    {90, "SnowQuest", "Snow Quest Giver", "Snow Bandit", 90},
    {105, "SnowQuest", "Snow Quest Giver", "Snowman", 100},
    {120, "MarineQuest2", "Marine Quest Giver", "Chief Petty Officer", 120},
    {130, "SkyExp1Quest", "Sky Quest Giver", "Sky Bandit", 150},
    {150, "SkyExp1Quest", "Sky Quest Giver", "Dark Master", 175},
    {175, "ColosseumQuest", "Quest Giver", "Toga Warrior", 180},
    {190, "ColosseumQuest", "Quest Giver", "Gladiator", 200},
}

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local VirtualUser = game:GetService("VirtualUser")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local CommF = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("CommF_")

-- Helper Functions
local function GetCurrentQuestData()
    local myLevel = LocalPlayer.Data.Level.Value
    local bestQuest = nil
    
    for _, q in ipairs(QuestList) do
        if myLevel >= q[1] then
            bestQuest = q
        end
    end
    return bestQuest
end

local function CheckActiveQuest()
    local PlayerGui = LocalPlayer:FindFirstChild("PlayerGui")
    if PlayerGui and PlayerGui:FindFirstChild("Main") and PlayerGui.Main:FindFirstChild("Quest") then
        return PlayerGui.Main.Quest.Visible
    end
    return false
end

local function TweenTo(targetCFrame)
    local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    if not Character:FindFirstChild("HumanoidRootPart") then return end
    
    local Distance = (Character.HumanoidRootPart.Position - targetCFrame.Position).Magnitude
    local Speed = 300 
    local Info = TweenInfo.new(Distance / Speed, Enum.EasingStyle.Linear)
    
    local Tween = TweenService:Create(Character.HumanoidRootPart, Info, {CFrame = targetCFrame})
    Tween:Play()
    
    -- Anti-Fall / NoClip during tween
    local Noclip = game:GetService("RunService").Stepped:Connect(function()
        for _, part in pairs(Character:GetChildren()) do
            if part:IsA("BasePart") then part.CanCollide = false end
        end
    end)
    
    Tween.Completed:Wait()
    Noclip:Disconnect()
end

local function FindNPC(name)
    for _, v in pairs(Workspace.NPCs:GetChildren()) do
        if v.Name == name or v.Name:find(name) then
            return v
        end
    end
    -- Fallback for some maps where NPCs are structured differently
    for _, v in pairs(Workspace:GetDescendants()) do
        if v.Name == name and v:IsA("Model") and v:FindFirstChild("Head") then
            return v
        end
    end
    return nil
end

-- Main Loop
spawn(function()
    while task.wait() do
        if _G.AutoFarm then
            pcall(function()
                local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
                if not Character:FindFirstChild("HumanoidRootPart") then return end
                
                local QuestData = GetCurrentQuestData()
                if not QuestData then return end -- No quest found for this level
                
                if _G.AutoQuest and not CheckActiveQuest() then
                    -- 1. Get Quest
                    local NPC = FindNPC(QuestData[3])
                    if NPC and NPC:FindFirstChild("HumanoidRootPart") then
                        if (Character.HumanoidRootPart.Position - NPC.HumanoidRootPart.Position).Magnitude > 10 then
                            TweenTo(NPC.HumanoidRootPart.CFrame)
                        else
                            -- Interact
                            CommF:InvokeServer("StartQuest", QuestData[2], 1)
                        end
                    end
                else
                    -- 2. Farm Mobs
                    local Target = nil
                    for _, v in pairs(Workspace.Enemies:GetChildren()) do
                        if v.Name == QuestData[4] and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
                            Target = v
                            break
                        end
                    end
                    
                    if Target then
                        -- Teleport/Tween to Mob
                        local AttackPos = Target.HumanoidRootPart.CFrame * CFrame.new(0, 5, 0)
                        local Distance = (Character.HumanoidRootPart.Position - AttackPos.Position).Magnitude
                        
                        if Distance > 250 then
                             TweenTo(AttackPos)
                        elseif Distance > 10 then
                             -- Fast movement for short distance
                             Character.HumanoidRootPart.CFrame = AttackPos
                        end
                        
                        -- Auto Attack
                        VirtualUser:CaptureController()
                        VirtualUser:Button1Down(Vector2.new(1280, 672))
                        
                        -- Equip Weapon (First Tool)
                        local Tool = LocalPlayer.Backpack:FindFirstChildOfClass("Tool")
                        if Tool then
                            LocalPlayer.Character.Humanoid:EquipTool(Tool)
                        end
                    else
                        -- Mob not found, wait for spawn
                        -- Optional: Teleport to spawn location if known
                    end
                end
            end)
        end
    end
end)

-- Stats Loop
spawn(function()
    while task.wait(0.5) do
        if _G.AutoStats then
            pcall(function()
                if LocalPlayer.Data.Points.Value > 0 then
                    local StatMap = {
                        ["Melee"] = "Melee",
                        ["Defense"] = "Defense",
                        ["Sword"] = "Sword",
                        ["Gun"] = "Gun",
                        ["Demon Fruit"] = "Demon Fruit" 
                    }
                    CommF:InvokeServer("AddPoint", StatMap[_G.SelectStat], 1)
                end
            end)
        end
    end
end)

-- UI Setup
MainTab:CreateToggle({
   Name = "Enable Auto Farm",
   CurrentValue = false,
   Callback = function(Value)
      _G.AutoFarm = Value
   end,
})

MainTab:CreateToggle({
   Name = "Auto Accept Quest",
   CurrentValue = true,
   Callback = function(Value)
      _G.AutoQuest = Value
   end,
})

MainTab:CreateLabel("Script will auto-detect level and quest")

StatsTab:CreateDropdown({
   Name = "Select Stat to Upgrade",
   Options = {"Melee", "Defense", "Sword", "Gun", "Demon Fruit"},
   CurrentOption = "Melee",
   Callback = function(Option)
      _G.SelectStat = Option
   end,
})

StatsTab:CreateToggle({
   Name = "Auto Stats",
   CurrentValue = false,
   Callback = function(Value)
      _G.AutoStats = Value
   end,
})

MiscTab:CreateToggle({
   Name = "Auto Chests",
   CurrentValue = false,
   Callback = function(Value)
      _G.AutoChest = Value
   end,
})

-- Auto Chest Loop
spawn(function()
    while task.wait(1) do
        if _G.AutoChest then
             pcall(function()
                local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
                for _, v in pairs(Workspace:GetChildren()) do
                    if v.Name:find("Chest") and (v.Position - Character.HumanoidRootPart.Position).Magnitude < 3000 then
                         TweenTo(v.CFrame)
                         wait(1)
                    end
                end
             end)
        end
    end
end)
