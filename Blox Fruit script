local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local VirtualUser = game:GetService("VirtualUser")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- // SETTINGS //
local Settings = {
    AutoParry = true,
    Visuals = true,
    AutoAbility = false, -- Авто-способности
    Range = 25, -- Дистанция для парирования
    CurveAdjust = 1.2, -- Поправка на скорость
    Debug = false
}

-- // UI SETUP //
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "PhantomBallHub"
ScreenGui.Parent = game.CoreGui or LocalPlayer:WaitForChild("PlayerGui")
ScreenGui.ResetOnSpawn = false

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 220, 0, 160)
MainFrame.Position = UDim2.new(0.1, 0, 0.2, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 10)
UICorner.Parent = MainFrame

local Title = Instance.new("TextLabel")
Title.Text = "Phantom Ball Hub"
Title.Size = UDim2.new(1, 0, 0, 30)
Title.BackgroundTransparency = 1
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 16
Title.Parent = MainFrame

-- Draggable Logic
local dragging, dragInput, dragStart, startPos
local function update(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end
MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then dragging = false end
        end)
    end
end)
MainFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then update(input) end
end)

-- Toggle Button
local ToggleBtn = Instance.new("TextButton")
ToggleBtn.Size = UDim2.new(0.9, 0, 0, 35)
ToggleBtn.Position = UDim2.new(0.05, 0, 0.3, 0)
ToggleBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
ToggleBtn.Text = "Auto Parry: ON"
ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleBtn.Font = Enum.Font.GothamSemibold
ToggleBtn.TextSize = 14
ToggleBtn.Parent = MainFrame
Instance.new("UICorner", ToggleBtn).CornerRadius = UDim.new(0, 6)

ToggleBtn.MouseButton1Click:Connect(function()
    Settings.AutoParry = not Settings.AutoParry
    ToggleBtn.Text = "Auto Parry: " .. (Settings.AutoParry and "ON" or "OFF")
    ToggleBtn.BackgroundColor3 = Settings.AutoParry and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 50, 50)
end)

-- Visuals Toggle
local VizBtn = Instance.new("TextButton")
VizBtn.Size = UDim2.new(0.9, 0, 0, 35)
VizBtn.Position = UDim2.new(0.05, 0, 0.55, 0) -- Чуть выше
VizBtn.BackgroundColor3 = Color3.fromRGB(50, 100, 200)
VizBtn.Text = "Visuals: ON"
VizBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
VizBtn.Font = Enum.Font.GothamSemibold
VizBtn.TextSize = 14
VizBtn.Parent = MainFrame
Instance.new("UICorner", VizBtn).CornerRadius = UDim.new(0, 6)

VizBtn.MouseButton1Click:Connect(function()
    Settings.Visuals = not Settings.Visuals
    VizBtn.Text = "Visuals: " .. (Settings.Visuals and "ON" or "OFF")
end)

-- Auto Ability Toggle
local AbilityBtn = Instance.new("TextButton")
AbilityBtn.Size = UDim2.new(0.9, 0, 0, 35)
AbilityBtn.Position = UDim2.new(0.05, 0, 0.8, 0)
AbilityBtn.BackgroundColor3 = Color3.fromRGB(200, 150, 50)
AbilityBtn.Text = "Auto Ability: OFF"
AbilityBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
AbilityBtn.Font = Enum.Font.GothamSemibold
AbilityBtn.TextSize = 14
AbilityBtn.Parent = MainFrame
Instance.new("UICorner", AbilityBtn).CornerRadius = UDim.new(0, 6)

AbilityBtn.MouseButton1Click:Connect(function()
    Settings.AutoAbility = not Settings.AutoAbility
    AbilityBtn.Text = "Auto Ability: " .. (Settings.AutoAbility and "ON" or "OFF")
    AbilityBtn.BackgroundColor3 = Settings.AutoAbility and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 150, 50)
end)

-- Increase Frame Size for new button
MainFrame.Size = UDim2.new(0, 220, 0, 210)

-- // LOGIC //

-- Visualizer Part
local VizPart = Instance.new("Part")
VizPart.Anchored = true
VizPart.CanCollide = false
VizPart.Material = Enum.Material.ForceField
VizPart.Shape = Enum.PartType.Ball
VizPart.Color = Color3.fromRGB(255, 0, 0)
VizPart.Transparency = 0.8
VizPart.Size = Vector3.new(Settings.Range, Settings.Range, Settings.Range)
VizPart.Parent = Workspace

local function GetBall()
    -- Попытка найти мяч. Обычно он называется "Ball" или находится в папке Balls
    -- Адаптируйте под конкретную игру, если название отличается
    local ball = Workspace:FindFirstChild("Ball") or Workspace:FindFirstChild("ClassicBall")
    
    if not ball then
        -- Поиск по тегам или внутри папок
        for _, v in pairs(Workspace:GetDescendants()) do
            if v.Name == "Ball" and v:IsA("BasePart") then
                return v
            end
        end
    end
    return ball
end

local function Parry()
    if not LocalPlayer.Character then return end
    
    -- 1. Эмуляция нажатия ButtonR1 (Блок) - Основной запрос пользователя
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.ButtonR1, false, game)
    task.wait(0.01)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.ButtonR1, false, game)
    
    -- 2. Эмуляция нажатия F (ПК Классика)
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.F, false, game)
    task.wait(0.01)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.F, false, game)
    
    -- 3. Эмуляция клика (ПК Мышь / Некоторые режимы)
    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 1)
    task.wait(0.01)
    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 1)
    
    -- 4. Для мобильных (Touch) - Прямая эмуляция тапа
    if UserInputService.TouchEnabled then
         VirtualUser:Button1Down(Vector2.new(0,0))
         VirtualUser:Button1Up(Vector2.new(0,0))
    end
    
    if Settings.Debug then print("Parry Attempted with R1/F/Click!") end
end

local function UseAbilities()
    if not Settings.AutoAbility then return end
    
    -- Ability 1: ButtonR2
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.ButtonR2, false, game)
    task.wait(0.05)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.ButtonR2, false, game)
    
    -- Ability 2: ButtonL2
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.ButtonL2, false, game)
    task.wait(0.05)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.ButtonL2, false, game)
end

RunService.RenderStepped:Connect(function()
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then return end
    
    local HRP = LocalPlayer.Character.HumanoidRootPart
    
    -- Обновление визуала
    if Settings.Visuals then
        VizPart.Parent = Workspace
        VizPart.Position = HRP.Position
        VizPart.Size = Vector3.new(Settings.Range * 2, Settings.Range * 2, Settings.Range * 2)
    else
        VizPart.Parent = nil
    end
end)

RunService.Heartbeat:Connect(function()
    if not Settings.AutoParry then return end
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then return end
    
    local ball = GetBall()
    if not ball then return end
    
    local HRP = LocalPlayer.Character.HumanoidRootPart
    local distance = (ball.Position - HRP.Position).Magnitude
    local velocity = ball.AssemblyLinearVelocity
    local speed = velocity.Magnitude
    
    -- Вектор движения мяча
    local ballDir = velocity.Unit
    -- Вектор от мяча к игроку
    local toPlayerDir = (HRP.Position - ball.Position).Unit
    
    -- Dot Product: Насколько мяч летит в нашу сторону (1 = прямо в нас)
    local dot = ballDir:Dot(toPlayerDir)
    
    -- Логика парирования
    -- Если мяч близко И летит в нашу сторону (dot > 0.4)
    if distance <= Settings.Range and dot > 0.4 then
        Parry()
        UseAbilities() -- Also try to use abilities if in combat
    elseif distance <= 15 then 
        -- Экстренное парирование если мяч очень близко (даже если летит боком/лагом)
        Parry()
        UseAbilities()
    end
    
    -- Адаптивная дистанция для высоких скоростей
    if speed > 50 then
        Settings.Range = math.clamp(speed / 2, 20, 100)
    else
        Settings.Range = 25
    end
end)

-- Уведомление о запуске
game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "Phantom Hub";
    Text = "Script Loaded! Press Toggle to Start.";
    Duration = 5;
})
