local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local PathfindingService = game:GetService("PathfindingService")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer

-- // SETTINGS & STATE //
local State = {
    ESP = false,
    CoinFarm = false,
    Speed = false,
    AutoAim = false,
    AutoShoot = false,
    AutoKnife = false,
    AutoGrab = false,
    AntiAFK = false,
    SpeedVal = 24
}

-- // UI LIBRARY (Simple & Modern) //
local Library = {}

function Library:CreateWindow()
    -- Cleanup old GUI
    if LocalPlayer.PlayerGui:FindFirstChild("MM2_Modern_UI") then
        LocalPlayer.PlayerGui.MM2_Modern_UI:Destroy()
    end

    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "MM2_Modern_UI"
    ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
    ScreenGui.ResetOnSpawn = false
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    -- Toggle Button (Mobile Friendly)
    local ToggleBtn = Instance.new("TextButton")
    ToggleBtn.Name = "ToggleBtn"
    ToggleBtn.Size = UDim2.new(0, 50, 0, 50)
    ToggleBtn.Position = UDim2.new(0, 10, 0.5, -25)
    ToggleBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    ToggleBtn.Text = "M"
    ToggleBtn.TextSize = 24
    ToggleBtn.Font = Enum.Font.GothamBold
    ToggleBtn.Parent = ScreenGui
    
    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(1, 0)
    UICorner.Parent = ToggleBtn

    -- Main Frame
    local MainFrame = Instance.new("Frame")
    MainFrame.Name = "MainFrame"
    MainFrame.Size = UDim2.new(0, 350, 0, 500)
    MainFrame.Position = UDim2.new(0.5, -175, 0.5, -250)
    MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    MainFrame.BorderSizePixel = 0
    MainFrame.Visible = false
    MainFrame.Parent = ScreenGui
    
    -- Draggable
    local Drag = Instance.new("UIDragDetector")
    Drag.Parent = MainFrame

    local MainCorner = Instance.new("UICorner")
    MainCorner.CornerRadius = UDim.new(0, 12)
    MainCorner.Parent = MainFrame

    -- Title
    local Title = Instance.new("TextLabel")
    Title.Text = "MM2 PRO v2.0"
    Title.Size = UDim2.new(1, -40, 0, 50)
    Title.Position = UDim2.new(0, 20, 0, 0)
    Title.BackgroundTransparency = 1
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.Font = Enum.Font.GothamBlack
    Title.TextSize = 24
    Title.TextXAlignment = Enum.TextXAlignment.Left
    Title.Parent = MainFrame

    -- Container for buttons
    local Container = Instance.new("ScrollingFrame")
    Container.Size = UDim2.new(1, -20, 1, -60)
    Container.Position = UDim2.new(0, 10, 0, 60)
    Container.BackgroundTransparency = 1
    Container.ScrollBarThickness = 4
    Container.Parent = MainFrame
    
    local UIList = Instance.new("UIListLayout")
    UIList.Padding = UDim.new(0, 10)
    UIList.SortOrder = Enum.SortOrder.LayoutOrder
    UIList.Parent = Container

    -- Toggle Logic
    ToggleBtn.MouseButton1Click:Connect(function()
        MainFrame.Visible = not MainFrame.Visible
    end)
    
    -- Mobile Check
    if UserInputService.TouchEnabled and not UserInputService.MouseEnabled then
        MainFrame.Size = UDim2.new(0.6, 0, 0.7, 0)
        MainFrame.Position = UDim2.new(0.2, 0, 0.15, 0)
        ToggleBtn.Position = UDim2.new(0, 10, 0.3, 0)
    end

    return Container
end

function Library:CreateButton(container, text, callback)
    local Button = Instance.new("TextButton")
    Button.Size = UDim2.new(1, -10, 0, 45)
    Button.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    Button.Text = text
    Button.TextColor3 = Color3.fromRGB(200, 200, 200)
    Button.Font = Enum.Font.GothamBold
    Button.TextSize = 16
    Button.Parent = container
    
    local Corner = Instance.new("UICorner")
    Corner.CornerRadius = UDim.new(0, 8)
    Corner.Parent = Button
    
    local enabled = false
    Button.MouseButton1Click:Connect(function()
        enabled = not enabled
        if enabled then
            Button.BackgroundColor3 = Color3.fromRGB(0, 180, 100)
            Button.TextColor3 = Color3.fromRGB(255, 255, 255)
            Button.Text = text .. " [ON]"
        else
            Button.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
            Button.TextColor3 = Color3.fromRGB(200, 200, 200)
            Button.Text = text
        end
        callback(enabled)
    end)
    return Button
end

-- // GAME LOGIC //

local function GetRole(plr)
    if not plr or not plr.Parent then return "Unknown" end
    local backpack = plr:FindFirstChild("Backpack")
    local char = plr.Character
    
    if not backpack or not char then return "Unknown" end
    
    if backpack:FindFirstChild("Knife") or char:FindFirstChild("Knife") then
        return "Murderer"
    elseif backpack:FindFirstChild("Gun") or char:FindFirstChild("Gun") then
        return "Sheriff"
    end
    
    return "Innocent"
end

-- ESP
local function UpdateESP()
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
            local role = GetRole(p)
            local color = Color3.fromRGB(0, 255, 0) -- Innocent
            
            if role == "Murderer" then color = Color3.fromRGB(255, 0, 0)
            elseif role == "Sheriff" then color = Color3.fromRGB(0, 0, 255)
            end
            
            local hl = p.Character:FindFirstChild("MM2Highlight")
            if not hl then
                hl = Instance.new("Highlight")
                hl.Name = "MM2Highlight"
                hl.Parent = p.Character
                hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
            end
            
            hl.FillColor = color
            hl.OutlineColor = Color3.fromRGB(255, 255, 255)
            hl.FillTransparency = 0.5
            hl.Enabled = State.ESP
        end
    end
end

-- Initialize
local Container = Library:CreateWindow()

Library:CreateButton(Container, "ESP (Roles)", function(val)
    State.ESP = val
    if not val then
        for _, p in pairs(Players:GetPlayers()) do
            if p.Character and p.Character:FindFirstChild("MM2Highlight") then
                p.Character.MM2Highlight:Destroy()
            end
        end
    end
end)

Library:CreateButton(Container, "Auto Farm Coins (Legit)", function(val)
    State.CoinFarm = val
end)

Library:CreateButton(Container, "Auto Shoot (Sheriff)", function(val)
    State.AutoShoot = val
end)

Library:CreateButton(Container, "Auto Knife (Murderer)", function(val)
    State.AutoKnife = val
end)

Library:CreateButton(Container, "Auto Grab Gun", function(val)
    State.AutoGrab = val
end)

Library:CreateButton(Container, "Speed Boost (24)", function(val)
    State.Speed = val
end)

Library:CreateButton(Container, "Silent Aim (Big Hitbox)", function(val)
    State.AutoAim = val
    if not val then
         for _, p in pairs(Players:GetPlayers()) do
            if p.Character and p.Character:FindFirstChild("Head") then
                p.Character.Head.Size = Vector3.new(1, 1, 1) -- MM2 standard head is 1,1,1 usually
                p.Character.Head.Transparency = 0
                p.Character.Head.CanCollide = true
            end
        end
    end
end)

-- // MAIN LOOPS //

-- ESP Loop
task.spawn(function()
    while task.wait(1) do
        if State.ESP then
            pcall(UpdateESP)
        end
    end
end)

-- Speed Loop
task.spawn(function()
    while task.wait() do
        if State.Speed and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.WalkSpeed = 24
        end
    end
end)

-- Coin Farm Loop
task.spawn(function()
    while task.wait() do
        if State.CoinFarm and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local map = Workspace:FindFirstChild("Normal")
            local coins = map and map:FindFirstChild("CoinContainer")
            
            if coins then
                local nearest = nil
                local minDst = math.huge
                
                for _, c in pairs(coins:GetChildren()) do
                    if c.Name == "Coin_Server" and c.Transparency == 0 then
                        local dst = (LocalPlayer.Character.HumanoidRootPart.Position - c.Position).Magnitude
                        if dst < minDst then
                            minDst = dst
                            nearest = c
                        end
                    end
                end
                
                if nearest then
                    local hum = LocalPlayer.Character.Humanoid
                    -- Simple MoveTo
                    hum:MoveTo(nearest.Position)
                    -- Check if stuck
                    local t = 0
                    while t < 2 and nearest.Transparency == 0 and State.CoinFarm do
                        task.wait(0.1)
                        t = t + 0.1
                        if (LocalPlayer.Character.HumanoidRootPart.Position - nearest.Position).Magnitude < 4 then
                            break
                        end
                    end
                end
            end
        end
    end
end)

-- Auto Shoot Loop
task.spawn(function()
    while task.wait(0.1) do
        if State.AutoShoot and LocalPlayer.Character then
            local myRole = GetRole(LocalPlayer)
            if myRole == "Sheriff" then
                local gun = LocalPlayer.Character:FindFirstChild("Gun") or LocalPlayer.Backpack:FindFirstChild("Gun")
                
                if gun then
                    local target = nil
                    for _, p in pairs(Players:GetPlayers()) do
                        if p ~= LocalPlayer and GetRole(p) == "Murderer" then
                            if p.Character and p.Character:FindFirstChild("Head") then
                                target = p.Character.Head
                            end
                            break
                        end
                    end
                    
                    if target then
                        -- Equip
                        if gun.Parent == LocalPlayer.Backpack then
                            LocalPlayer.Character.Humanoid:EquipTool(gun)
                            task.wait(0.1)
                        end
                        
                        -- Aim & Shoot
                        local origin = LocalPlayer.Character.Head.Position
                        local dir = (target.Position - origin).Unit * 200
                        local ray = Ray.new(origin, dir)
                        local hit, pos = Workspace:FindPartOnRayWithIgnoreList(ray, {LocalPlayer.Character})
                        
                        if hit and hit:IsDescendantOf(target.Parent) then
                            -- Look at target
                            LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(LocalPlayer.Character.HumanoidRootPart.Position, Vector3.new(target.Position.X, LocalPlayer.Character.HumanoidRootPart.Position.Y, target.Position.Z))
                            
                            -- Shoot
                            gun:Activate()
                        end
                    end
                end
            end
        end
    end
end)

-- Auto Knife Loop
task.spawn(function()
    while task.wait(0.1) do
        if State.AutoKnife and LocalPlayer.Character then
            local myRole = GetRole(LocalPlayer)
            if myRole == "Murderer" then
                local knife = LocalPlayer.Character:FindFirstChild("Knife") or LocalPlayer.Backpack:FindFirstChild("Knife")
                
                if knife then
                    local target = nil
                    local minDst = 15 -- Range
                    
                    for _, p in pairs(Players:GetPlayers()) do
                        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                            local dst = (LocalPlayer.Character.HumanoidRootPart.Position - p.Character.HumanoidRootPart.Position).Magnitude
                            if dst < minDst then
                                target = p.Character.HumanoidRootPart
                                minDst = dst
                            end
                        end
                    end
                    
                    if target then
                         if knife.Parent == LocalPlayer.Backpack then
                            LocalPlayer.Character.Humanoid:EquipTool(knife)
                        end
                        
                        -- Chase
                        LocalPlayer.Character.Humanoid:MoveTo(target.Position)
                        
                        if minDst < 5 then
                            knife:Activate()
                        end
                    end
                end
            end
        end
    end
end)

-- Silent Aim Loop
task.spawn(function()
    while task.wait(0.5) do
        if State.AutoAim then
            local myRole = GetRole(LocalPlayer)
            
            for _, p in pairs(Players:GetPlayers()) do
                if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("Head") then
                    local targetRole = GetRole(p)
                    local isEnemy = false
                    
                    if myRole == "Murderer" then
                        isEnemy = true
                    elseif (myRole == "Sheriff" or myRole == "Innocent") and targetRole == "Murderer" then
                        isEnemy = true
                    end
                    
                    if isEnemy then
                        p.Character.Head.Size = Vector3.new(10, 10, 10)
                        p.Character.Head.Transparency = 0.7
                        p.Character.Head.CanCollide = false
                        p.Character.Head.Color = Color3.fromRGB(255, 0, 0)
                    else
                        p.Character.Head.Size = Vector3.new(1, 1, 1)
                        p.Character.Head.Transparency = 0
                        p.Character.Head.Color = Color3.fromRGB(255, 255, 255) -- Reset color might be tricky, usually skin color
                    end
                end
            end
        end
    end
end)

-- Auto Grab Gun
task.spawn(function()
    while task.wait(0.5) do
        if State.AutoGrab and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local gunDrop = Workspace:FindFirstChild("GunDrop")
            if gunDrop then
                 LocalPlayer.Character.Humanoid:MoveTo(gunDrop.Position)
            end
        end
    end
end)

print("MM2 PRO v2 Loaded")
