local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local PathfindingService = game:GetService("PathfindingService")

local _G = _G or {}
_G.ESP = false
_G.CoinFarm = false
_G.Speed = false
_G.XRay = false
_G.AutoAim = false

-- // GUI SETUP //
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MM2_GUI_v1"
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
ScreenGui.ResetOnSpawn = false

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 320, 0, 400)
MainFrame.Position = UDim2.new(0.5, -160, 0.5, -200)
MainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 10)
UICorner.Parent = MainFrame

-- Заголовок
local Title = Instance.new("TextLabel")
Title.Text = "MM2 SCRIPT v1.0 (ESP + FARM)"
Title.Size = UDim2.new(1, 0, 0, 50)
Title.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 22
Title.Parent = MainFrame

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 10)
TitleCorner.Parent = Title

-- Функция создания кнопок
local function CreateToggle(text, yPos, callback)
    local btn = Instance.new("TextButton")
    btn.Text = text
    btn.Size = UDim2.new(0.9, 0, 0, 40)
    btn.Position = UDim2.new(0.05, 0, 0, yPos)
    btn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.Font = Enum.Font.SourceSansBold
    btn.TextSize = 18
    btn.Parent = MainFrame
    
    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 8)
    btnCorner.Parent = btn
    
    local on = false
    btn.MouseButton1Click:Connect(function()
        on = not on
        if on then
            btn.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
            btn.Text = text .. " [ON]"
        else
            btn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
            btn.Text = text
        end
        callback(on)
    end)
end

-- // ФУНКЦИИ //

-- 1. Определение ролей (ESP)
local function GetRole(plr)
    local hasKnife = false
    local hasGun = false
    
    -- Проверяем Backpack (инвентарь) и Character (в руках)
    if plr.Backpack:FindFirstChild("Knife") or (plr.Character and plr.Character:FindFirstChild("Knife")) then
        hasKnife = true
    end
    
    if plr.Backpack:FindFirstChild("Gun") or (plr.Character and plr.Character:FindFirstChild("Gun")) then
        hasGun = true
    end
    
    -- Иногда оружие скрыто или имеет другое имя, но стандартно так:
    if hasKnife then return "Murderer", Color3.fromRGB(255, 0, 0) end
    if hasGun then return "Sheriff", Color3.fromRGB(0, 0, 255) end
    return "Innocent", Color3.fromRGB(0, 255, 0)
end

-- Кнопка ESP
CreateToggle("Player ESP (Roles)", 70, function(val)
    _G.ESP = val
    if not val then
        -- Очистка при выключении
        for _, p in pairs(Players:GetPlayers()) do
            if p.Character then
                if p.Character:FindFirstChild("MM2Highlight") then p.Character.MM2Highlight:Destroy() end
                if p.Character:FindFirstChild("Head") and p.Character.Head:FindFirstChild("RoleTag") then
                    p.Character.Head.RoleTag:Destroy()
                end
            end
        end
        local gunDrop = Workspace:FindFirstChild("GunDrop")
        if gunDrop and gunDrop:FindFirstChild("GunHighlight") then
            gunDrop.GunHighlight:Destroy()
        end
    end
end)

-- Логика ESP
task.spawn(function()
    while task.wait(1) do
        if _G.ESP then
            for _, p in pairs(Players:GetPlayers()) do
                if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") and p.Character:FindFirstChild("Head") then
                    local role, color = GetRole(p)
                    
                    -- Подсветка (Highlight)
                    local hl = p.Character:FindFirstChild("MM2Highlight")
                    if not hl then
                        hl = Instance.new("Highlight")
                        hl.Name = "MM2Highlight"
                        hl.Parent = p.Character
                        hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                    end
                    hl.FillColor = color
                    hl.OutlineColor = Color3.fromRGB(255, 255, 255)
                    hl.FillTransparency = 0.5
                    
                    -- Текст над головой
                    local bg = p.Character.Head:FindFirstChild("RoleTag")
                    if not bg then
                        bg = Instance.new("BillboardGui")
                        bg.Name = "RoleTag"
                        bg.Size = UDim2.new(0, 200, 0, 50)
                        bg.StudsOffset = Vector3.new(0, 3, 0)
                        bg.AlwaysOnTop = true
                        bg.Parent = p.Character.Head
                        
                        local txt = Instance.new("TextLabel")
                        txt.Parent = bg
                        txt.Size = UDim2.new(1, 0, 1, 0)
                        txt.BackgroundTransparency = 1
                        txt.TextStrokeTransparency = 0
                        txt.Font = Enum.Font.SourceSansBold
                        txt.TextSize = 16
                        txt.TextColor3 = color
                        txt.Text = role
                    else
                        bg.TextLabel.Text = role .. " [" .. math.floor((LocalPlayer.Character.HumanoidRootPart.Position - p.Character.HumanoidRootPart.Position).Magnitude) .. "m]"
                        bg.TextLabel.TextColor3 = color
                        hl.FillColor = color
                    end
                end
            end
            
            -- ESP на выпавший пистолет
            local gunDrop = Workspace:FindFirstChild("GunDrop")
            if gunDrop then
                local hl = gunDrop:FindFirstChild("GunHighlight")
                if not hl then
                    hl = Instance.new("Highlight")
                    hl.Name = "GunHighlight"
                    hl.FillColor = Color3.fromRGB(255, 255, 0) -- Желтый
                    hl.OutlineColor = Color3.fromRGB(255, 0, 0)
                    hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                    hl.Parent = gunDrop
                end
            end
        end
    end
end)

-- 2. Auto Farm Coins (Авто-сбор монет)
CreateToggle("Auto Farm Coins", 120, function(val)
    _G.CoinFarm = val
end)

task.spawn(function()
    while task.wait() do
        if _G.CoinFarm and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character:FindFirstChild("Humanoid") then
            local map = Workspace:FindFirstChild("Normal")
            local coinContainer = map and map:FindFirstChild("CoinContainer") or nil
            local hrp = LocalPlayer.Character.HumanoidRootPart
            local humanoid = LocalPlayer.Character.Humanoid
            local nearestCoin
            local nearestDist = math.huge
            if coinContainer then
                for _, coin in pairs(coinContainer:GetChildren()) do
                    if coin.Name == "Coin_Server" and coin.Transparency == 0 then
                        local d = (hrp.Position - coin.Position).Magnitude
                        if d < nearestDist then
                            nearestDist = d
                            nearestCoin = coin
                        end
                    end
                end
            end
            if nearestCoin then
                local path = PathfindingService:CreatePath()
                path:ComputeAsync(hrp.Position, nearestCoin.Position)
                if path.Status == Enum.PathStatus.Success then
                    for _, wp in ipairs(path:GetWaypoints()) do
                        humanoid:MoveTo(wp.Position)
                        humanoid.MoveToFinished:Wait()
                        if not _G.CoinFarm or nearestCoin.Transparency ~= 0 then
                            break
                        end
                    end
                else
                    humanoid:MoveTo(nearestCoin.Position)
                    humanoid.MoveToFinished:Wait()
                end
            else
                task.wait(0.2)
            end
        end
    end
end)

-- 3. Speed Boost (Скорость)
CreateToggle("Speed Boost (Walkspeed)", 170, function(val)
    _G.Speed = val
end)

task.spawn(function()
    while task.wait() do
        if _G.Speed and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.WalkSpeed = 24
        end
    end
end)

-- 4. God Mode / Ghost (Призрачный режим)
CreateToggle("Ghost Mode (Invis)", 220, function(val)
    if LocalPlayer.Character then
        for _, v in pairs(LocalPlayer.Character:GetDescendants()) do
            if v:IsA("BasePart") or v:IsA("Decal") then
                v.Transparency = val and 1 or 0
            end
        end
    end
end)

CreateToggle("Auto Aim", 270, function(val)
    _G.AutoAim = val
end)

task.spawn(function()
    while task.wait() do
        if _G.AutoAim and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local camera = Workspace.CurrentCamera
            local target
            local targetColor
            for _, p in pairs(Players:GetPlayers()) do
                if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") and p.Character:FindFirstChild("Head") then
                    local role, color = GetRole(p)
                    if role == "Murderer" then
                        target = p
                        targetColor = color
                        break
                    end
                end
            end
            if not target then
                local nearest
                local dist = math.huge
                for _, p in pairs(Players:GetPlayers()) do
                    if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") and p.Character:FindFirstChild("Head") then
                        local d = (LocalPlayer.Character.HumanoidRootPart.Position - p.Character.HumanoidRootPart.Position).Magnitude
                        if d < dist then
                            dist = d
                            nearest = p
                        end
                    end
                end
                target = nearest
            end
            if target and target.Character and target.Character:FindFirstChild("Head") then
                local head = target.Character.Head
                camera.CFrame = CFrame.new(camera.CFrame.Position, head.Position)
            end
        end
    end
end)
-- Кнопка закрытия
local CloseBtn = Instance.new("TextButton")
CloseBtn.Text = "CLOSE"
CloseBtn.Size = UDim2.new(0.9, 0, 0, 40)
CloseBtn.Position = UDim2.new(0.05, 0, 0, 340)
CloseBtn.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
CloseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseBtn.Font = Enum.Font.SourceSansBold
CloseBtn.TextSize = 18
CloseBtn.Parent = MainFrame

CloseBtn.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
end)

print("MM2 Script Loaded!")
