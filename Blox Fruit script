--[[ VETA HUB - BLOX FRUITS GOD MODE v7.1 MOBILE EDITION ]]
-- Автор: VETA AI (улучшено LARB HACK)
-- Совместимость: iOS / Android / PC | Blox Fruits v25+

local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game.Workspace
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")

local Player = Players.LocalPlayer
if not Player then return end

-- Ждём загрузки персонажа
repeat wait() until Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")

--// КОНФИГУРАЦИЯ UI (МОБИЛЬНАЯ ОПТИМИЗАЦИЯ)
local UIConfig = {
    MainColor = Color3.fromRGB(0, 120, 255),
    Background = Color3.fromRGB(20, 20, 30),
    Sidebar = Color3.fromRGB(15, 15, 25),
    Text = Color3.fromRGB(255, 255, 255),
    Font = Enum.Font.GothamBold,
    Transparency = 0.15,
    ButtonSize = UDim2.new(0, 200, 0, 50), -- увеличено для телефона
    ToggleSize = UDim2.new(0, 80, 0, 30)
}

--// ГЛОБАЛЬНЫЕ НАСТРОЙКИ
_G.VetaConfig = {
    AutoFarm = false,
    AutoStats = false,
    SelectedStat = "Melee",
    FastAttack = true,
    ESP = false,
    FruitESP = false,
    SelectedWeapon = "Melee"
}

local CurrentStatus = "Idle"

--// ДИНАМИЧЕСКИЙ ПОИСК REMOTE
local function GetMainRemote()
    for _, child in ipairs(ReplicatedStorage:GetDescendants()) do
        if child:IsA("RemoteEvent") and child.Name:find("Main") then
            return child
        end
    end
    -- fallback: первый RemoteEvent
    for _, child in ipairs(ReplicatedStorage:GetDescendants()) do
        if child:IsA("RemoteEvent") then return child end
    end
end

local MainRemote = GetMainRemote()

--// ФУНКЦИИ
local function UpdateStatus(text)
    CurrentStatus = text
end

local function Teleport(CF)
    local HR = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
    if HR then
        HR.CFrame = CF
    end
end

local function GetWeaponList()
    local list = {}
    local char = Player.Character
    local backpack = Player:FindFirstChild("Backpack")
    if char then
        for _, v in pairs(char:GetChildren()) do
            if v:IsA("Tool") then table.insert(list, v.Name) end
        end
    end
    if backpack then
        for _, v in pairs(backpack:GetChildren()) do
            if v:IsA("Tool") then table.insert(list, v.Name) end
        end
    end
    return list
end

local function EquipWeapon(name)
    local char = Player.Character
    local backpack = Player:FindFirstChild("Backpack")
    if not char or not backpack then return end
    if char:FindFirstChild(name) then return end
    local tool = backpack:FindFirstChild(name)
    if tool then
        char.Humanoid:EquipTool(tool)
    end
end

--// ДИНАМИЧЕСКИЙ ПОИСК КВЕСТА
local function GetCurrentQuest()
    local levelObj = Player:FindFirstChild("Data") and Player.Data:FindFirstChild("Level")
    if not levelObj then return nil end
    local lvl = levelObj.Value

    local npcs = Workspace:FindFirstChild("NPCFolder") or Workspace:FindFirstChild("NPCs")
    if not npcs then return nil end

    local best = {Lvl = -1, NPC = nil, Mob = "", Quest = ""}
    for _, npc in pairs(npcs:GetChildren()) do
        if npc:IsA("Model") and npc:FindFirstChild("HumanoidRootPart") then
            local name = npc.Name
            local mobName = name:match("(.+)%s%[Lv%.%s*(%d+)%]")
            if mobName then
                local npcLvl = tonumber(mobName:match("%d+")) or 0
                if npcLvl <= lvl and npcLvl > best.Lvl then
                    best = {
                        Lvl = npcLvl,
                        NPC = npc,
                        Mob = mobName:gsub("%s%[Lv%.%s*%d+%]", ""),
                        Quest = npc.Name
                    }
                end
            end
        end
    end
    return best.Lvl >= 0 and best or nil
end

--// АТАКА (БЕЗ VirtualUser!)
local function Attack()
    if MainRemote then
        pcall(function()
            MainRemote:FireServer("Attack")
            MainRemote:FireServer("Abilities", "Buso")
        end)
    end
end

--// UI СОЗДАНИЕ
local function CreateUI()
    local gui = Instance.new("ScreenGui")
    gui.Name = "VetaHub_Mobile"
    gui.ResetOnSpawn = false
    gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    gui.Parent = CoreGui

    -- Защита от удаления
    game.DescendantRemoving:Connect(function(obj)
        if obj == gui then
            task.spawn(function()
                wait()
                pcall(function() gui:Clone().Parent = CoreGui end)
            end)
        end
    end)

    -- Открыть кнопку
    local openBtn = Instance.new("TextButton")
    openBtn.Size = UDim2.new(0, 60, 0, 60)
    openBtn.Position = UDim2.new(0, 10, 0.5, -30)
    openBtn.BackgroundColor3 = UIConfig.MainColor
    openBtn.Text = "V"
    openBtn.TextColor3 = Color3.new(1,1,1)
    openBtn.Font = UIConfig.Font
    openBtn.TextSize = 28
    openBtn.Parent = gui

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(1, 0)
    corner.Parent = openBtn

    -- Главное окно
    local main = Instance.new("Frame")
    main.Size = UDim2.new(0, 320, 0, 400)
    main.Position = UDim2.new(0.5, -160, 0.5, -200)
    main.BackgroundColor3 = UIConfig.Background
    main.BackgroundTransparency = UIConfig.Transparency
    main.Visible = false
    main.Parent = gui

    local mainCorner = Instance.new("UICorner")
    mainCorner.CornerRadius = UDim.new(0, 12)
    mainCorner.Parent = main

    -- Статус
    local status = Instance.new("TextLabel")
    status.Size = UDim2.new(1, -20, 0, 30)
    status.Position = UDim2.new(0, 10, 0, 10)
    status.BackgroundTransparency = 1
    status.Text = "Status: Idle"
    status.TextColor3 = Color3.fromRGB(100, 255, 100)
    status.Font = UIConfig.Font
    status.TextSize = 14
    status.Parent = main

    -- Табы
    local tabs = {}
    local content = {}

    local function AddTab(name)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(1, -20, 0, 40)
        btn.Position = UDim2.new(0, 10, 0, #tabs * 45 + 50)
        btn.Text = name
        btn.BackgroundColor3 = Color3.fromRGB(30,30,40)
        btn.TextColor3 = UIConfig.Text
        btn.Font = UIConfig.Font
        btn.Parent = main

        local page = Instance.new("Frame")
        page.Size = UDim2.new(1, -20, 1, -100)
        page.Position = UDim2.new(0, 10, 0, 100)
        page.BackgroundTransparency = 1
        page.Visible = (#tabs == 0)
        page.Parent = main

        table.insert(tabs, btn)
        table.insert(content, page)

        btn.MouseButton1Click:Connect(function()
            for i, p in ipairs(content) do
                p.Visible = (tabs[i] == btn)
            end
            for _, b in ipairs(tabs) do
                b.BackgroundColor3 = (b == btn) and UIConfig.MainColor or Color3.fromRGB(30,30,40)
            end
        end)

        return {
            Toggle = function(label, def, cb)
                local frame = Instance.new("Frame")
                frame.Size = UDim2.new(1, 0, 0, 40)
                frame.BackgroundColor3 = Color3.fromRGB(40,40,50)
                frame.Parent = page

                local txt = Instance.new("TextLabel")
                txt.Size = UDim2.new(0.7, 0, 1, 0)
                txt.Position = UDim2.new(0, 10, 0, 0)
                txt.BackgroundTransparency = 1
                txt.Text = label
                txt.TextColor3 = UIConfig.Text
                txt.Font = UIConfig.Font
                txt.TextSize = 14
                txt.Parent = frame

                local toggle = Instance.new("TextButton")
                toggle.Size = UIConfig.ToggleSize
                toggle.Position = UDim2.new(1, -90, 0.5, -15)
                toggle.BackgroundColor3 = def and UIConfig.MainColor or Color3.fromRGB(60,60,70)
                toggle.Text = ""
                toggle.Parent = frame

                local circle = Instance.new("Frame")
                circle.Size = UDim2.new(0, 20, 0, 20)
                circle.BackgroundColor3 = Color3.new(1,1,1)
                circle.Position = def and UDim2.new(1, -22, 0.5, -10) or UDim2.new(0, 2, 0.5, -10)
                circle.Parent = toggle

                local active = def
                toggle.MouseButton1Click:Connect(function()
                    active = not active
                    toggle.BackgroundColor3 = active and UIConfig.MainColor or Color3.fromRGB(60,60,70)
                    circle:TweenPosition(active and UDim2.new(1, -22, 0.5, -10) or UDim2.new(0, 2, 0.5, -10), "Out", "Quad", 0.15, true)
                    cb(active)
                end)
            end,

            Button = function(label, cb)
                local btn = Instance.new("TextButton")
                btn.Size = UIConfig.ButtonSize
                btn.Text = label
                btn.BackgroundColor3 = Color3.fromRGB(40,40,50)
                btn.TextColor3 = UIConfig.Text
                btn.Font = UIConfig.Font
                btn.TextSize = 14
                btn.Parent = page

                btn.MouseButton1Click:Connect(function()
                    cb()
                end)
            end,

            Dropdown = function(label, opts, cb)
                local frame = Instance.new("Frame")
                frame.Size = UDim2.new(1, 0, 0, 40)
                frame.ClipsDescendants = true
                frame.BackgroundColor3 = Color3.fromRGB(40,40,50)
                frame.Parent = page

                local txt = Instance.new("TextLabel")
                txt.Size = UDim2.new(1, -30, 1, 0)
                txt.Position = UDim2.new(0, 10, 0, 0)
                txt.BackgroundTransparency = 1
                txt.Text = label
                txt.TextColor3 = UIConfig.Text
                txt.Font = UIConfig.Font
                txt.TextSize = 14
                txt.Parent = frame

                local isOpen = false
                frame.MouseButton1Click:Connect(function()
                    isOpen = not isOpen
                    frame:TweenSize(isOpen and UDim2.new(1, 0, 0, 40 + #opts * 35) or UDim2.new(1, 0, 0, 40), "Out", "Quad", 0.2, true)
                end)

                local function Refresh(newOpts)
                    opts = newOpts
                    for _, c in ipairs(frame:GetChildren()) do
                        if c ~= txt then c:Destroy() end
                    end
                    for i, opt in ipairs(opts) do
                        local b = Instance.new("TextButton")
                        b.Size = UDim2.new(1, -10, 0, 30)
                        b.Position = UDim2.new(0, 5, 0, 40 + (i-1)*35)
                        b.Text = opt
                        b.BackgroundColor3 = Color3.fromRGB(50,50,60)
                        b.TextColor3 = Color3.fromRGB(220,220,220)
                        b.Font = UIConfig.Font
                        b.TextSize = 13
                        b.Parent = frame
                        b.MouseButton1Click:Connect(function()
                            txt.Text = label .. ": " .. opt
                            cb(opt)
                            isOpen = false
                            frame:TweenSize(UDim2.new(1, 0, 0, 40), "Out", "Quad", 0.2, true)
                        end)
                    end
                end

                Refresh(opts)
                return { Refresh = Refresh }
            end
        }
    end

    openBtn.MouseButton1Click:Connect(function()
        main.Visible = not main.Visible
    end)

    return AddTab, status
end

--// ИНИЦИАЛИЗАЦИЯ UI
local AddTab, StatusBar = CreateUI()

-- Farm Tab
local farm = AddTab("Auto Farm")
local weaponDrop = farm.Dropdown("Weapon", {"Melee", "Sword"}, function(v)
    _G.VetaConfig.SelectedWeapon = v
end)

farm.Button("Refresh Weapons", function()
    weaponDrop.Refresh(GetWeaponList())
end)

farm.Toggle("Auto Farm", false, function(v)
    _G.VetaConfig.AutoFarm = v
end)

farm.Toggle("Fast Attack", true, function(v)
    _G.VetaConfig.FastAttack = v
end)

-- Visuals Tab
local vis = AddTab("Visuals")
vis.Toggle("Mob ESP", false, function(v)
    _G.VetaConfig.ESP = v
end)

-- Stats Tab
local stats = AddTab("Stats")
stats.Dropdown("Stat", {"Melee", "Defense", "Sword", "Gun", "Demon Fruit"}, function(v)
    _G.VetaConfig.SelectedStat = v
end)

--// ЛОГИКА: AUTO FARM (БЕСПЕРЕБОЙНО)
task.spawn(function()
    while true do
        task.wait(_G.VetaConfig.FastAttack and 0.1 or 0.5)
        if StatusBar then
            StatusBar.Text = "Status: " .. CurrentStatus
        end

        if _G.VetaConfig.AutoFarm and Player.Character then
            local quest = GetCurrentQuest()
            if not quest then
                UpdateStatus("No valid quest")
            else
                local npcs = Workspace:FindFirstChild("NPCFolder") or Workspace:FindFirstChild("NPCs")
                local currentQuestGui = Player.PlayerGui:FindFirstChild("Main") and Player.PlayerGui.Main:FindFirstChild("Quest")
                if not currentQuestGui or not currentQuestGui.Visible then
                    -- Принять квест
                    if quest.NPC then
                        local dist = (Player.Character.HumanoidRootPart.Position - quest.NPC.HumanoidRootPart.Position).Magnitude
                        if dist > 500 then
                            UpdateStatus("Teleporting...")
                            Teleport(quest.NPC.HumanoidRootPart.CFrame)
                        elseif dist < 10 then
                            if MainRemote then
                                pcall(function()
                                    MainRemote:FireServer("StartQuest", quest.Quest, 1)
                                end)
                            end
                        else
                            Teleport(quest.NPC.HumanoidRootPart.CFrame * CFrame.new(0,0,5))
                        end
                    end
                else
                    -- Фарм мобов
                    local enemies = Workspace:FindFirstChild("Enemies")
                    if enemies then
                        local target = nil
                        for _, mob in ipairs(enemies:GetChildren()) do
                            if mob:IsA("Model") and mob:FindFirstChild("Humanoid") and mob.Humanoid.Health > 0 then
                                if mob.Name:find(quest.Mob) then
                                    target = mob
                                    break
                                end
                            end
                        end
                        if target then
                            Teleport(target.HumanoidRootPart.CFrame * CFrame.new(0,0,5))
                            EquipWeapon(_G.VetaConfig.SelectedWeapon)
                            Attack()
                            UpdateStatus("Killing: " .. target.Name)
                        else
                            UpdateStatus("Waiting for mobs...")
                        end
                    end
                end
            end
        else
            UpdateStatus("Idle")
        end
    end
end)

--// ESP (МОБИЛЬНЫЙ РЕЖИМ)
task.spawn(function()
    local espFolder = Instance.new("Folder")
    espFolder.Name = "VetaESPContainer"
    espFolder.Parent = CoreGui

    while true do
        task.wait(0.1)
        if _G.VetaConfig.ESP and Player.Character then
            local cam = Workspace.CurrentCamera
            local enemies = Workspace:FindFirstChild("Enemies")
            if enemies then
                -- Очистка старых
                for _, old in ipairs(espFolder:GetChildren()) do
                    old:Destroy()
                end

                for _, mob in ipairs(enemies:GetChildren()) do
                    if mob:IsA("Model") and mob:FindFirstChild("Humanoid") and mob.Humanoid.Health > 0 and mob:FindFirstChild("Head") then
                        local pos, vis = cam:WorldToViewportPoint(mob.Head.Position + Vector3.new(0,2,0))
                        if vis and pos.Z > 0 then
                            local esp = Instance.new("TextLabel")
                            esp.BackgroundTransparency = 1
                            esp.Position = UDim2.new(0, pos.X - 50, 0, pos.Y - 20)
                            esp.Size = UDim2.new(0, 100, 0, 40)
                            esp.Text = string.format("%s\nHP: %d", mob.Name, math.floor(mob.Humanoid.Health))
                            esp.TextColor3 = Color3.new(1, 0, 0)
                            esp.TextStrokeColor3 = Color3.new(0,0,0)
                            esp.TextStrokeTransparency = 0
                            esp.Font = Enum.Font.Code
                            esp.TextSize = 14
                            esp.Parent = espFolder
                        end
                    end
                end
            end
        else
            espFolder:ClearAllChildren()
        end
    end
end)

UpdateStatus("Ready (Mobile Mode)")
